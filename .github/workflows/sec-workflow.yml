name: Reusable Security Analysis Workflow

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
      PKG_MAVEN_USERNAME:
        required: true
      PKG_MAVEN_TOKEN:
        required: true

jobs:
  gradle-dependency-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PKG_MAVEN_USERNAME: ${{ secrets.PKG_MAVEN_USERNAME }}
      PKG_MAVEN_TOKEN: ${{ secrets.PKG_MAVEN_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2
      - name: Setup Gradle with GitHub Package Registry
        uses: komune-io/fixers-gradle/.github/actions/setup-gradle-github-pkg@main
      - name: Submit Dependency Graph to Gradle Enterprise
        uses: gradle/actions/dependency-submission@v3

  sonarcloud-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Gradle for SonarCloud Analysis
        uses: gradle/gradle-build-action@v3
      - name: Setup Gradle with GitHub Package Registry for SonarCloud
        uses: komune-io/fixers-gradle/.github/actions/setup-gradle-github-pkg@main
      - name: Run SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  codacy-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Run Codacy Analysis
        uses: codacy/codacy-analysis-cli-action@v4
        with:
          output: results.sarif
          format: sarif
          gh-code-scanning-compat: true
          max-allowed-issues: 2147483647
      - name: Upload SARIF File to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif