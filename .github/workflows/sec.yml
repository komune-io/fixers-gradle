name: Security Analysis Workflow

on:
  # Run after Dev workflow completes on main/release
  workflow_run:
    workflows: ["Dev"]
    types: [completed]
    branches: [main, 'release/*']

  # Keep PR trigger for independent analysis
  pull_request:
    types: [opened, synchronize, labeled]

jobs:
  sec:
    # Skip if triggered by workflow_run and the run failed
    if: github.event.workflow_run.conclusion != 'failure'
    uses: ./.github/workflows/sec-workflow.yml
    with:
      workflow-run-id: ${{ github.event.workflow_run.id }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    permissions:
      contents: write
      pull-requests: read
      security-events: write
      packages: read